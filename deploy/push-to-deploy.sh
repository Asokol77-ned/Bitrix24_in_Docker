#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ bitrix/ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–µ–ø–ª–æ—è (r4s.git)
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç git subtree –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–æ–ª—å–∫–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–∞–ø–∫–∏ bitrix/
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy/push-to-deploy.sh [commit_message]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

cd "$PROJECT_ROOT"

echo "üöÄ –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π Bitrix –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–µ–ø–ª–æ—è..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–∞–ø–∫–∏ bitrix
if [ ! -d "bitrix" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ø–∞–ø–∫–∞ bitrix –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–æ–≤ –≤ bitrix (–∫—Ä–æ–º–µ .gitkeep)
if [ -z "$(find bitrix -type f ! -name '.gitkeep' ! -path '*/\.*' | head -1)" ]; then
    echo "‚ÑπÔ∏è  –ü–∞–ø–∫–∞ bitrix –ø—É—Å—Ç–∞ –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Å–ª—É–∂–µ–±–Ω—ã–µ —Ñ–∞–π–ª—ã"
    echo "   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Bitrix –≤ Docker –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π"
    exit 0
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è remote deploy
if ! git remote | grep -q "^deploy$"; then
    echo "üîó –î–æ–±–∞–≤–ª–µ–Ω–∏–µ remote –¥–ª—è –¥–µ–ø–ª–æ—è..."
    git remote add deploy https://github.com/Asokol77-ned/r4s.git
fi

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–º–∏—Ç–∞
COMMIT_MSG="${1:-Update Bitrix code from Docker development}"

# –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã
if [ -n "$(git status --porcelain)" ]; then
    echo "üìù –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
    echo "   –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–µ–ø–ª–æ—è"
    echo "   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: git add . && git commit -m '–≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'"
    exit 1
fi

# –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–ª—å–∫–æ –ø–∞–ø–∫–∏ bitrix/ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–µ–ø–ª–æ—è –∏—Å–ø–æ–ª—å–∑—É—è subtree
echo "‚¨ÜÔ∏è  –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∞–ø–∫–∏ bitrix/ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–µ–ø–ª–æ—è..."
git subtree push --prefix=bitrix deploy main || {
    echo "‚ö†Ô∏è  –í–µ—Ç–∫–∞ main –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–µ–ø–ª–æ—è, –ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å..."
    git subtree push --prefix=bitrix deploy main --rejoin || {
        echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≤–µ—Ç–∫–∏ main –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–µ–ø–ª–æ—è..."
        # –ï—Å–ª–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø—É—Å—Ç–æ–π, —Å–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
        git push deploy $(git subtree split --prefix=bitrix):main --force
    }
}

echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–µ–ø–ª–æ—è!"
echo "üåê –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: https://github.com/Asokol77-ned/r4s.git"
